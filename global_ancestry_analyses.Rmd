---
title: "Global ancestry analyses"
author: "Melissa Spear"
date: "06/05/2020"
output: html_document
---

The following describes the analyses discussed within the global ancestry analyses of the paper. This includes Figures 1-2, Table 1, Supplementary Figures 1-6 and Supplementay Table 1. The HCHS/SOL data can be accessed itself through dbGaP Study Accession phs000810.v1.p1. HRS data for Supplementary Figure 5 was made available under IRB Study No. A11-E91-13B.

#####Reading in the admixture run file, subsetting the reference pops, extracting admixed samples 
```{r}
#Read in the admixture file estimates file 
HCHS_SOL_admixture_file<-read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED.3.Q", header =F, sep = ' ')
names(HCHS_SOL_admixture_file) <- c("YRI","CEU","AI")

#Reading in the fam file accompaniment of the .bed file called for the admixture run 
fam_file = read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED.fam", header=F, sep = ' ')
fam_file_with_IDs <- cbind(fam_file, HCHS_SOL_admixture_file)

#subset ref pops
CEU<-fam_file_with_IDs[1:104,] #subset the CEU ref pop
YRI<-fam_file_with_IDs[105:211,] #subset the YRI ref pop
AI<-fam_file_with_IDs[212:323,] #subset the AI ref pop 

all_ref<-rbind(CEU,YRI,AI)

#all HCHS/SOL with reference pops 
dim(fam_file_with_IDs)
```

##### Reading in the HCHS/SOL phenotype files and merging with the global ancestry estimates 
```{r}
#Read in the HCHS/SOL phenotype file 
HCHS_SOL_pheno<-read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_allphenotypes_ALL_samples_new_birthyear.txt", header= T, sep = '\t')

#merge the admixture estimates with the pheno file 
all_with_pheno=merge(fam_file_with_IDs, HCHS_SOL_pheno, by.x =c("V1"), by.y=c("SUBJECT_ID"))
dim(all_with_pheno) #minus the ref
```


#####Subsetting the admixed 95 HCHS/SOL populations 
```{r}
#Dominican subset 
Dominican<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == "0"),]
dim(Dominican)
```

```{r}
#Central American subset
Central_American<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == "1"),]
dim(Central_American)
```

```{r}
#Cuban subset
Cuban<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == "2"),]
dim(Cuban)
```

```{r}
#Mexican subset 
Mexican<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == "3"),]
dim(Mexican)
```

```{r}
#Puerto Rican subset 
Puerto_Rican<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == "4"),]
dim(Puerto_Rican)
```

```{r}
#South American subset 
South_American<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == "5"),]
dim(South_American)
```

```{r}
#Mixed/Other samples
mixed_other<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == '6'),]
dim(mixed_other)
```

The following section is for Figure 1 of the paper 

Loading in plot dependicies 
```{r}
#Package utilized for Figures 1A and 1B 
library('Ternary') 
require(RColorBrewer)
pcol=brewer.pal(9, "Set1")
```

```{r}
#Figure 1A 
all_with_pheno2<-all_with_pheno[,7:9]
all_with_pheno3<-subset(all_with_pheno,select=c("CEU","AI","YRI"))
AncCol=c("#E41A1C","#377EB8","#4DAF4A")

AncRGB=col2rgb(AncCol)/255
#pdf("HCHS_SOL_ternary_admixture_gradients_mixed_other_091019_figure_1A.pdf",height=2.375,width=2.375,pointsize=10)
par(mar=c(2.1,2.1,0.1,0.1))
TernaryPlot(alab="African ancestry (%)",blab="European ancestry (%)",clab="Amerindigenous ancestry (%)",lab.cex=0.6,axis.cex = 0.5)
nmh=all_with_pheno3; #Needed to reorder ancestry order to get the color I wanted for each, Ryan wrote this script befroe we decided to change the colors for eahc of the pops and I was too lazy to figure out the indeces :) 

for(i in 1:nrow(all_with_pheno2)){
  ired = nmh[i,1]*AncRGB[1,1] + nmh[i,2]*AncRGB[2,1] + nmh[i,3]*AncRGB[3,1]
  igreen = nmh[i,1]*AncRGB[1,2] + nmh[i,2]*AncRGB[2,2] + nmh[i,3]*AncRGB[3,2]
  iblue = nmh[i,1]*AncRGB[1,3] + nmh[i,2]*AncRGB[2,3] + nmh[i,3]*AncRGB[3,3]
  AddToTernary(points,all_with_pheno2[i,1:3],col=rgb(ired,igreen,iblue,1),pch=16,cex=0.5)
}

#dev.off()
```

```{r}
#Figure 1B
#pdf("HCHS_SOL_allpops_including_unadmixed_mixed_other_ternaryplot_102419_supplementary_Figure_1A.pdf",height=2.375,width=2.375,pointsize=10)
par(mar=c(2.1,2.1,0.1,0.1))
TernaryPlot(alab="African ancestry (%)",blab="European ancestry (%)",clab="Amerindigenous ancestry (%)",lab.cex=0.6,axis.cex = 0.5)
legend("topleft",cex=0.45,col=c("#E41A1C","#377EB8","#4DAF4A","#984EA3","#FF7F00","#FFFF33","#A65628"), pch=16,legend=c("Mexican","Cuban","Dominican","Central American","Puerto Rican","South American","Mixed/Other"), bty="n")
AddToTernary(points,Mexican[,7:9],col=pcol[1],pch=16,cex=0.5)
AddToTernary(points,Cuban[,7:9],col=pcol[2],pch=16,cex=0.5)
AddToTernary(points,Dominican[,7:9],col=pcol[3],pch=16,cex=0.5)
AddToTernary(points,Central_American[,7:9],col=pcol[4],pch=16,cex=0.5)
AddToTernary(points,Puerto_Rican[,7:9],col=pcol[5],pch=16,cex=0.5)
AddToTernary(points,South_American[,7:9],col=pcol[6],pch=16,cex=0.5)
AddToTernary(points,mixed_other[,7:9],col=pcol[7],pch=16,cex=0.5)
#dev.off()
```


The following section is for Figure 2 of the paper. 

Subsetting out the admixed 95 samples 
```{r}
#Extracting out only the 95% admixed samples
admixed_with_pheno<-all_with_pheno[which(all_with_pheno$CEU <= 0.95 & all_with_pheno$YRI <=0.95 & all_with_pheno$AI <=0.95),]

#admixed_with_pheno<-merge(admixed_95, HCHS_SOL_pheno, by.x =c("V1"), by.y=c("SUBJECT_ID"))
dim(admixed_with_pheno)
```

#####Subsetting the admixed 95 HCHS/SOL populations.
These are the sample sizes listed in Supplementary Table 1. 
```{r}
#Dominican subset 
Dominican_admixed<-admixed_with_pheno[which(admixed_with_pheno$BKGRD1_C7 == "0"),]
dim(Dominican_admixed)
```

```{r}
#Central American subset
Central_American_admixed<-admixed_with_pheno[which(admixed_with_pheno$BKGRD1_C7 == "1"),]
dim(Central_American_admixed)
```

```{r}
#Cuban subset
Cuban_admixed<-admixed_with_pheno[which(admixed_with_pheno$BKGRD1_C7 == "2"),]
dim(Cuban_admixed)
```

```{r}
#Mexican subset 
Mexican_admixed<-admixed_with_pheno[which(admixed_with_pheno$BKGRD1_C7 == "3"),]
dim(Mexican_admixed)
```

```{r}
#Puerto Rican subset 
Puerto_Rican_admixed<-admixed_with_pheno[which(admixed_with_pheno$BKGRD1_C7 == "4"),]
dim(Puerto_Rican_admixed)
```

```{r}
#South American subset 
South_American_admixed<-admixed_with_pheno[which(admixed_with_pheno$BKGRD1_C7 == "5"),]
dim(South_American_admixed)
```





```{r}
##Plot Figure 2A
#pdf("Amerindigenous_ancestry_ancestry_points+wiskers_dbins_081319_Figure1C.pdf",height=2.25,width=2.375,pointsize=10)
par(mar=c(2.1,2.1,0.1,0.1))
plot(1,1,type='n',xlim=range(d[,284]),ylim=c(0,1),xlab="",ylab="",xaxt='n',yaxt='n')
abline(h=seq(0,1,by=0.1),col=rgb(0,0,0,0.1))
abline(v=seq(1930,2000,by=5),col=rgb(0,0,0,0.1))
axis(side=1,padj=-2,cex.axis=0.7)
axis(side=2,padj=1.5,cex.axis=0.7, at=c("0.0","0.2","0.4","0.6","0.8","1.0"), labels=c("0","20","40","60","80","100"))
mtext(side=1,"Birth year",line=1.1)
mtext(side=2,"Amerindigenous ancestry (%)",line=1.1)
c=col2rgb(pcol[2])/255;
I1 = which.min(d[,284])
I2 = which.max(d[,284])
points(d[,284],d[,9],col=rgb(c[1],c[2],c[3],0.2),pch=16,cex=0.5)
segments(x0=d[I1,284], x1=d[I2,284],y0=fit$fitted.values[I1],y1=fit$fitted.values[I2],col="white",lwd=3)
segments(x0=d[I1,284], x1=d[I2,284],y0=fit$fitted.values[I1],y1=fit$fitted.values[I2],col=pcol[2],lwd=2)
pw = 10 #partition width, in years
part=seq(min(floor(d[,9]/10)*10),max(ceiling(d[,284]/10)*10),by=pw)
for(i in 1:(length(part)-1)){
  q1 = max(part[i],min(d[,284]));
  q2 = min(part[i+1],max(d[,284]));
  dbin = d[which(d[,284]>q1 & d[,284]<=q2),]
  m = mean(dbin[,9],na.rm=T)
  se = 2*sd(dbin[,9],na.rm=T)/sqrt(nrow(dbin))
  segments(x0=q1,x1=q2,y0=m)
  segments(x0=(q1+q2)/2,y0=m-se,y1=m+se)
  cat(i,q1,q2,m,se,"\n",sep="\t")
}
#dev.off()
```

The following section is for Table 1 of the paper 

The following section is for Supplementary Figure 1 of the paper 

The following section is for Supplementary Figure 2 of the paper 

The following section is for Supplementary Figure 3 of the paper.

The following section is for Supplementary Figure 4 of the paper 

The following section is for Supplementary Figure 5 of the paper.

The following section is for Supplementary Table 1 of the paper. 



This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
