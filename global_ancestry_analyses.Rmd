---
title: "Global ancestry analyses"
author: "Melissa Spear"
date: "06/05/2020"
output: html_document
---

The following describes the analyses discussed within the global ancestry analyses of the paper. This includes Figures 1-2, Table 1, Supplementary Figures 1-6 and Supplementay Table 1. The HCHS/SOL data can be accessed itself through dbGaP Study Accession phs000810.v1.p1. HRS data for Supplementary Figure 5 was made available under IRB Study No. A11-E91-13B.

#####Reading in the admixture run file, subsetting the reference pops, extracting admixed samples 
```{r}
#Read in the admixture file estimates file 
HCHS_SOL_admixture_file<-read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED.3.Q", header =F, sep = ' ')
names(HCHS_SOL_admixture_file) <- c("YRI","CEU","AI")

#Reading in the fam file accompaniment of the .bed file called for the admixture run 
fam_file = read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED.fam", header=F, sep = ' ')
names(fam_file)<-c("FID","IID","PID","MID","Sex","Pheno")
fam_file_with_IDs <- cbind(fam_file, HCHS_SOL_admixture_file)

#subset ref pops
CEU<-fam_file_with_IDs[1:104,] #subset the CEU ref pop
YRI<-fam_file_with_IDs[105:211,] #subset the YRI ref pop
AI<-fam_file_with_IDs[212:323,] #subset the AI ref pop 

all_ref<-rbind(CEU,YRI,AI)

#all HCHS/SOL with reference pops 
dim(fam_file_with_IDs)
```

##### Reading in the HCHS/SOL phenotype files and merging with the global ancestry estimates 
```{r}
#Read in the HCHS/SOL phenotype file 
HCHS_SOL_pheno<-read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_allphenotypes_ALL_samples_new_birthyear.txt", header= T, sep = '\t')

#merge the admixture estimates with the pheno file 
all_with_pheno=merge(fam_file_with_IDs, HCHS_SOL_pheno, by.x =c("FID"), by.y=c("SUBJECT_ID"))
dim(all_with_pheno) #minus the ref
```


#####Subsetting the admixed 95 HCHS/SOL populations 
```{r}
#Dominican subset 
Dominican<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == "0"),]
dim(Dominican)
```

```{r}
#Central American subset
Central_American<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == "1"),]
dim(Central_American)
```

```{r}
#Cuban subset
Cuban<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == "2"),]
dim(Cuban)
```

```{r}
#Mexican subset 
Mexican<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == "3"),]
dim(Mexican)
```

```{r}
#Puerto Rican subset 
Puerto_Rican<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == "4"),]
dim(Puerto_Rican)
```

```{r}
#South American subset 
South_American<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == "5"),]
dim(South_American)
```

```{r}
#Mixed/Other samples
mixed_other<-all_with_pheno[which(all_with_pheno$BKGRD1_C7 == '6'),]
dim(mixed_other)
```

##The following section is for Figure 1 of the paper 

```{r}
#Loading in package dependicies for Figure 1
library('Ternary') 
require(RColorBrewer)
pcol<-brewer.pal(9, "Set1")
set3<-brewer.pal(9,"Set3")
```

```{r}
#Figure 1A 
all_with_pheno2<-all_with_pheno[,7:9]
all_with_pheno3<-subset(all_with_pheno,select=c("CEU","AI","YRI"))
AncCol=c("#E41A1C","#377EB8","#4DAF4A")

AncRGB=col2rgb(AncCol)/255
#pdf("HCHS_SOL_ternary_admixture_gradients_mixed_other_091019_figure_1A.pdf",height=2.375,width=2.375,pointsize=10)
par(mar=c(2.1,2.1,0.1,0.1))
TernaryPlot(alab="African ancestry (%)",blab="European ancestry (%)",clab="Amerindigenous ancestry (%)",lab.cex=0.6,axis.cex = 0.5)
nmh=all_with_pheno3; #Needed to reorder ancestry order to get the color I wanted for each, Ryan wrote this script befroe we decided to change the colors for eahc of the pops and I was too lazy to figure out the indeces :) 

for(i in 1:nrow(all_with_pheno2)){
  ired = nmh[i,1]*AncRGB[1,1] + nmh[i,2]*AncRGB[2,1] + nmh[i,3]*AncRGB[3,1]
  igreen = nmh[i,1]*AncRGB[1,2] + nmh[i,2]*AncRGB[2,2] + nmh[i,3]*AncRGB[3,2]
  iblue = nmh[i,1]*AncRGB[1,3] + nmh[i,2]*AncRGB[2,3] + nmh[i,3]*AncRGB[3,3]
  AddToTernary(points,all_with_pheno2[i,1:3],col=rgb(ired,igreen,iblue,1),pch=16,cex=0.5)
}
#dev.off()
```

```{r}
#Figure 1B
#pdf("HCHS_SOL_allpops_including_unadmixed_mixed_other_ternaryplot_102419_supplementary_Figure_1A.pdf",height=2.375,width=2.375,pointsize=10)
par(mar=c(2.1,2.1,0.1,0.1))
TernaryPlot(alab="African ancestry (%)",blab="European ancestry (%)",clab="Amerindigenous ancestry (%)",lab.cex=0.6,axis.cex = 0.5)
legend("topleft",cex=0.45,col=c("#E41A1C","#377EB8","#4DAF4A","#984EA3","#FF7F00","#FFFF33","#A65628"), pch=16,legend=c("Mexican","Cuban","Dominican","Central American","Puerto Rican","South American","Mixed/Other"), bty="n")
AddToTernary(points,Mexican[,7:9],col=pcol[1],pch=16,cex=0.5)
AddToTernary(points,Cuban[,7:9],col=pcol[2],pch=16,cex=0.5)
AddToTernary(points,Dominican[,7:9],col=pcol[3],pch=16,cex=0.5)
AddToTernary(points,Central_American[,7:9],col=pcol[4],pch=16,cex=0.5)
AddToTernary(points,Puerto_Rican[,7:9],col=pcol[5],pch=16,cex=0.5)
AddToTernary(points,South_American[,7:9],col=pcol[6],pch=16,cex=0.5)
AddToTernary(points,mixed_other[,7:9],col=pcol[7],pch=16,cex=0.5)
#dev.off()
```

Reading in the UMAP results needed for Figure 1C 
```{r}
#read in umap results 
umap_results_filename<-"/Users/melissaspear/Dropbox/HCHS_SOL/UMAP/overlap_with_ref/projections/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED_UMAP_PC3_NC2_NN15_MD0.5_201944194827.txt"
umap_results<-read.table(umap_results_filename,header=F,sep=' ')

#merge IDs with umap results (same fam file run with admixture and smartpca thus why not reading in again) 
final_umap_file<-cbind(fam_file,umap_results)

#Adding the Population labels for each of the reference groups 
CEU_umap<-final_umap_file[1:104,]
CEU_umap$Population = "CEU" 

YRI_umap<-final_umap_file[105:211,]
YRI_umap$Population = "YRI"

AI_umap<-final_umap_file[212:323,]
AI_umap$Population = "AI"

reference_umap<-rbind(CEU_umap, YRI_umap, AI_umap)

#Subsetting the phenotype file
pheno_shortened<-subset(HCHS_SOL_pheno, select = c("SUBJECT_ID", "BKGRD1_C7"))

combined_pheno_fam<-merge(pheno_shortened, fam_file, by.x=c("SUBJECT_ID"), by.y =c("FID"))

#merging the umap results with the HCHS/SOL phenotypes 
umap_pheno<-merge(combined_pheno_fam, final_umap_file, by.x=c("SUBJECT_ID"), by.y =c("FID"))
#subset for variables needed for plot itself 
umap_pheno_subset<-subset(umap_pheno, select=c("IID.x","BKGRD1_C7","V1","V2"))
```

```{r}
#subset the latinx groups 
Dominican_reclassified<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "0"),]

Central_American_reclassified<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "1"),]

Cuban_reclassified<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "2"),]

Mexican_reclassified<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "3"),]

Puerto_Rican_reclassified<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "4"),]

South_American_reclassified<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "5"),]

Mixed_Other<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "6"),]


Cuban_reclassified$Population = "Cuban"
Dominican_reclassified$Population = "Dominican"
Puerto_Rican_reclassified$Population = "Puerto Rican"
Mexican_reclassified$Population = "Mexican"
Central_American_reclassified$Population = "Central American"
South_American_reclassified$Population = "South American"
Mixed_Other$Population = "Mixed_Other"


all_Latinx_pops<-rbind(Cuban_reclassified,Dominican_reclassified, Puerto_Rican_reclassified, Mexican_reclassified, Central_American_reclassified, South_American_reclassified, Mixed_Other)
Final_Latinx_pops<-subset(all_Latinx_pops,select=c("IID.x","Population","V1","V2"))
names(Final_Latinx_pops)<-c("IID","Population","V1","V2")

Final_reference=subset(reference_umap,select=c("IID","Population","V1","V2"))  

all_pops<-rbind(Final_Latinx_pops,Final_reference)  


```

```{r}
#Figure 1C 
##Final code for plotting by admixture gradients 

input<-"/Users/melissaspear/Dropbox/HCHS_SOL/UMAP/overlap_with_ref/projections/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED_UMAP_PC3_NC2_NN15_MD0.5_201944194827.txt"
umap_results  <- read.table(input,header=F)
final_umap_file<-cbind(fam_file,umap_results)
admixture_estimates_filename<-"/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED.3.Q"
admixture_estimates<-read.table(admixture_estimates_filename,header=F,sep=" ")
AncCol=c("#E41A1C","#377EB8","#4DAF4A")
admixture_estimates3<-subset(admixture_estimates,select=c("V2","V3","V1"))

AncRGB=col2rgb(AncCol)/255
#pdf("HCHS_SOL_Umap_PC3_admixture_gradients_071519.pdf",height=2.375,width=2.375,pointsize=5)
par(mar=c(2.1,2.1,0.1,0.1))  
plot(umap_results,pch=0,type='n',xlab="",ylab="",xaxt='n',yaxt='n',bty='n')
ae=admixture_estimates3
for(i in 1:nrow(ae)){
  ired = ae[i,1]*AncRGB[1,1] + ae[i,2]*AncRGB[2,1] + ae[i,3]*AncRGB[3,1]
  igreen = ae[i,1]*AncRGB[1,2] + ae[i,2]*AncRGB[2,2] + ae[i,3]*AncRGB[3,2]
  iblue = ae[i,1]*AncRGB[1,3] + ae[i,2]*AncRGB[2,3] + ae[i,3]*AncRGB[3,3]
  points(umap_results[i,],col=rgb(ired,igreen,iblue,1),pch=5,cex=0.1)
}
#dev.off()  
```


```{r}
#Legend for 1C 
AncCol=c("#4DAF4A","#E41A1C","#377EB8")

AncRGB=col2rgb(AncCol)/255
#pdf("UMAP_ternary_plot_Figure1B_legend.pdf",height=2.375,width=2.375,pointsize=10)
par(mar=c(2.1,2.1,0.1,0.1))
TernaryPlot(alab=expression(''%->% "African ancestry (%)" %->% ''),blab=expression(''%->%"European ancestry (%)" %->% ''),clab=expression(''%<-% "Amerindigenous ancestry (%)" %<-% ''),lab.cex=0.6,axis.cex = 0.5)
dx=0.01;
cnt=0
bk=0;
for(xi in seq(0,1,length=round(1/dx))){
  for(yi in seq(0,1,length=round(1/dx))){
    for(zi in seq(0,1,length=round(1/dx))){
      if(abs(1-(xi+yi+zi)) < 1e-8){
        ired = xi*AncRGB[1,1] + yi*AncRGB[1,2] + zi*AncRGB[1,3]
        igreen = xi*AncRGB[2,1] + yi*AncRGB[2,2] + zi*AncRGB[2,3]
        iblue = xi*AncRGB[3,1] + yi*AncRGB[3,2] + zi*AncRGB[3,3]
        AddToTernary(points,c(xi,yi,zi),col=rgb(ired,igreen,iblue,1),pch=20)
        cnt=cnt+1
      }
    }
  }
}
#dev.off()
```

```{r}
#plot Figure 1D 
pdf('/Users/melissaspear/Dropbox/HCHS_SOL/UMAP/overlap_with_ref/plots/HCHS_SOL_with_ref_mixed_other_101819_3PCs_muted_ref_new_figure1d.pdf',height=2.375,width=2.375,pointsize=5)
par(mar=c(2.1,2.1,0.1,0.1))  
#par(mar=c(3,3,1,1))
plot(all_pops$V1,all_pops$V2,pch=0,type='n',xlab="",ylab="",xaxt='n',yaxt='n',bty='n')
legend("bottomleft",legend=c("CEU","AI","YRI","Mexican","Cuban","Dominican","Central American","Puerto Rican","South American","Mixed/Other"),col=c(set3[9],set3[9],set3[9],pcol[1],pcol[2],pcol[3],pcol[4],pcol[5],pcol[6],pcol[7]),pch=5,cex=0.75,bg='white',bty='n')
points(Mexican_reclassified$V1,Mexican_reclassified$V2,col=pcol[1],pch=5,cex=0.1)
points(Central_American_reclassified$V1,Central_American_reclassified$V2,col=pcol[4],pch=5,cex=0.1)
points(South_American_reclassified$V1,South_American_reclassified$V2,col=pcol[6],pch=5,cex=0.1)
points(Dominican_reclassified$V1,Dominican_reclassified$V2,col=pcol[3],pch=5,cex=0.1)
points(Cuban_reclassified$V1,Cuban_reclassified$V2,col=pcol[2],pch=5,cex=0.1)
points(Puerto_Rican_reclassified$V1,Puerto_Rican_reclassified$V2,col=pcol[5],pch=5,cex=0.1)
points(Mixed_Other$V1,Mixed_Other$V2,col=pcol[7],pch=5,cex=0.1)
points(CEU_umap$V1,CEU_umap$V2,col=set3[9],pch=5,cex=0.1)
points(YRI_umap$V1,YRI_umap$V2,col=set3[9],pch=5,cex=0.1)
points(AI_umap$V1,AI_umap$V2,col=set3[9],pch=5,cex=0.1)
dev.off()

```



#### The following section is for Figure 2 of the paper. 

Subsetting out the admixed 95 samples 
```{r}
#Extracting out only the 95% admixed samples
admixed_with_pheno<-all_with_pheno[which(all_with_pheno$CEU <= 0.95 & all_with_pheno$YRI <=0.95 & all_with_pheno$AI <=0.95),]

#admixed_with_pheno<-merge(admixed_95, HCHS_SOL_pheno, by.x =c("V1"), by.y=c("SUBJECT_ID"))
dim(admixed_with_pheno)
```

#####Subsetting the admixed 95 HCHS/SOL populations.
These are the sample sizes listed in Supplementary Table 1. 
```{r}
#Dominican subset 
Dominican_admixed<-admixed_with_pheno[which(admixed_with_pheno$BKGRD1_C7 == "0"),]
dim(Dominican_admixed)
```

```{r}
#Central American subset
Central_American_admixed<-admixed_with_pheno[which(admixed_with_pheno$BKGRD1_C7 == "1"),]
dim(Central_American_admixed)
```

```{r}
#Cuban subset
Cuban_admixed<-admixed_with_pheno[which(admixed_with_pheno$BKGRD1_C7 == "2"),]
dim(Cuban_admixed)
```

```{r}
#Mexican subset 
Mexican_admixed<-admixed_with_pheno[which(admixed_with_pheno$BKGRD1_C7 == "3"),]
dim(Mexican_admixed)
```

```{r}
#Puerto Rican subset 
Puerto_Rican_admixed<-admixed_with_pheno[which(admixed_with_pheno$BKGRD1_C7 == "4"),]
dim(Puerto_Rican_admixed)
```

```{r}
#South American subset 
South_American_admixed<-admixed_with_pheno[which(admixed_with_pheno$BKGRD1_C7 == "5"),]
dim(South_American_admixed)
```


```{r}
##Plot Figure 2A

#phenotype file of the admixed 95 mexican samples 
d = read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_Mexicans_admixed_95_full_pheno_010919.txt",header=T,sep='\t')

N=nrow(d)

fit = lm(d[,9] ~ d[,284]+log(d[,179])) #linear model: AI ancestry vs birth year


#pdf("Amerindigenous_ancestry_ancestry_points+wiskers_dbins_081319_Figure1C.pdf",height=2.25,width=2.375,pointsize=10)
par(mar=c(2.1,2.1,0.1,0.1))
plot(1,1,type='n',xlim=range(d[,284]),ylim=c(0,1),xlab="",ylab="",xaxt='n',yaxt='n')
abline(h=seq(0,1,by=0.1),col=rgb(0,0,0,0.1))
abline(v=seq(1930,2000,by=5),col=rgb(0,0,0,0.1))
axis(side=1,padj=-2,cex.axis=0.7)
axis(side=2,padj=1.5,cex.axis=0.7, at=c("0.0","0.2","0.4","0.6","0.8","1.0"), labels=c("0","20","40","60","80","100"))
mtext(side=1,"Birth year",line=1.1)
mtext(side=2,"Amerindigenous ancestry (%)",line=1.1)
c=col2rgb(pcol[2])/255;
I1 = which.min(d[,284])
I2 = which.max(d[,284])
points(d[,284],d[,9],col=rgb(c[1],c[2],c[3],0.2),pch=16,cex=0.5)
segments(x0=d[I1,284], x1=d[I2,284],y0=fit$fitted.values[I1],y1=fit$fitted.values[I2],col="white",lwd=3)
segments(x0=d[I1,284], x1=d[I2,284],y0=fit$fitted.values[I1],y1=fit$fitted.values[I2],col=pcol[2],lwd=2)
pw = 10 #partition width, in years
part=seq(min(floor(d[,9]/10)*10),max(ceiling(d[,284]/10)*10),by=pw)
for(i in 1:(length(part)-1)){
  q1 = max(part[i],min(d[,284]));
  q2 = min(part[i+1],max(d[,284]));
  dbin = d[which(d[,284]>q1 & d[,284]<=q2),]
  m = mean(dbin[,9],na.rm=T)
  se = 2*sd(dbin[,9],na.rm=T)/sqrt(nrow(dbin))
  segments(x0=q1,x1=q2,y0=m)
  segments(x0=(q1+q2)/2,y0=m-se,y1=m+se)
  cat(i,q1,q2,m,se,"\n",sep="\t")
}
#dev.off()
```


```{r}
#Figure 2B
MX_pheno<-read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_Mexicans_admixed_95_full_pheno_010919.txt",header=T,sep='\t')

set.seed(123)
fit.native = lm(NAM ~ estimated_birth_year+ log(WEIGHT_FINAL_NORM_OVERALL),data=MX_pheno)

#Bootstrap iterations of global ancestry 
library(boot)

boot_fn <- function(data, indices) {
  d <- data[indices, ]
  d <- d[order(d$estimated_birth_year),]
  loess_fit <- loess(NAM ~ estimated_birth_year, d,
                     control = loess.control(surface = "direct"))
  predict(loess_fit, data.frame(estimated_birth_year = seq(1934, 1993, 1)), se = T)$fit
}

loess_boot <- boot(MX_pheno, R = 1000, statistic = boot_fn)

``` 

```{r}
pdf("/Users/melissaspear/Dropbox/HCHS_SOL/paper_figures/NativeAmerican_ancestry_bootstrap_loess_linear_081319_new_figure_2B.pdf",height=2.25,width=2.375,pointsize=10)
par(mar=c(2.1,2.1,0.1,0.1))
plot(1,1,type='n',xlim=range(d[,284]),ylim=c(0.38,0.55),xlab="",ylab="",xaxt='n',yaxt='n')
abline(h=seq(0.35,0.6,by=0.05),col=rgb(0,0,0,0.1))
abline(v=seq(1930,2000,by=5),col=rgb(0,0,0,0.1))
axis(side=1,padj=-2,cex.axis=0.60,cex.lab=0.90)
axis(side=2,padj=1.5,cex.axis=0.60,cex.lab=0.90,at=c("0.35","0.4","0.45","0.5","0.55","0.6"), labels=c("35","40","45","50","55","60"))
mtext(side=1,"Birth year",line=1.1)
mtext(side=2,"Amerindigenous ancestry (%)",line=1.1)
#plot(MX_pheno$estimated_birth_year, MX_pheno$NAM,ylim=c(0.3,0.6),pch = 20, col = "black", xlab = "Birth year",
     #ylab = "Native American ancestry (%)")
for(i in sample(nrow(loess_boot$t), 1000)) { #function to plot each row on top of one another 
  lines(seq(1934, 1993, 1), loess_boot$t[i,], col = "gray",lwd=0.75)
}
I1 = which.min(d[,284])
I2 = which.max(d[,284])
segments(x0=d[I1,284], x1=d[I2,284],y0=fit.native$fitted.values[I1],y1=fit.native$fitted.values[I2],col="white",lwd=4)
segments(x0=d[I1,284], x1=d[I2,284],y0=fit.native$fitted.values[I1],y1=fit.native$fitted.values[I2],col=pcol[2],lwd=3)
pw = 10 #partition width, in years
part=seq(min(floor(d[,9]/10)*10),max(ceiling(d[,284]/10)*10),by=pw)
for(i in 1:(length(part)-1)){
  q1 = max(part[i],min(d[,284]));
  q2 = min(part[i+1],max(d[,284]));
  dbin = d[which(d[,284]>q1 & d[,284]<=q2),]
  m = mean(dbin[,9],na.rm=T)
  se = 2*sd(dbin[,9],na.rm=T)/sqrt(nrow(dbin))
  segments(x0=q1,x1=q2,y0=m)
  segments(x0=(q1+q2)/2,y0=m-se,y1=m+se)
  cat(i,q1,q2,m,se,"\n",sep="\t")
}
conf_97.5 <- apply(loess_boot$t, 2, function(x) quantile(x, .975))
conf_2.5 <- apply(loess_boot$t, 2, function(x) quantile(x, .025))
lines(seq(1934, 1993, 1), conf_97.5, type ="l",
      col = "black", lty=5)
lines(seq(1934, 1993, 1), conf_2.5, type ="l",
      col = "black",lty=5)
dev.off()

```



The following section is for Table 1 of the paper 

```{r}
Mexican_reclassified<-read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_Mexicans_admixed_95_full_pheno_010919.txt",header=T,sep='\t')

#Migrant status
US_born = Mexican_reclassified[which(Mexican_reclassified$US_BORN == '1'),]
US_migrant = Mexican_reclassified[which(Mexican_reclassified$US_BORN == '0'),]

US_born_model<-lm(NAM ~ estimated_birth_year+log(WEIGHT_FINAL_NORM_OVERALL), data = US_born)
US_migrant_model<-lm(NAM ~ estimated_birth_year+log(WEIGHT_FINAL_NORM_OVERALL), data = US_migrant)

#Region 
Chicago = Mexican_reclassified[which(Mexican_reclassified$CENTER == 'C'),]
San_Diego = Mexican_reclassified[which(Mexican_reclassified$CENTER == 'S'),]
Miami = Mexican_reclassified[which(Mexican_reclassified$CENTER == 'M'),]
Bronx = Mexican_reclassified[which(Mexican_reclassified$CENTER == 'B'),]

Chicago_model<-lm(NAM ~ estimated_birth_year+log(WEIGHT_FINAL_NORM_OVERALL), data = Chicago)
San_Diego_model<-lm(NAM ~ estimated_birth_year+log(WEIGHT_FINAL_NORM_OVERALL), data = San_Diego)

#Educational_attainment
Mexican_less_high_school = Mexican_reclassified[which(Mexican_reclassified$EDUCATION_C3 == '1'),]
Mexican_high_school = Mexican_reclassified[which(Mexican_reclassified$EDUCATION_C3 == '2'),]
Mexican_higher_high_school = Mexican_reclassified[which(Mexican_reclassified$EDUCATION_C3 == '3'),]


Mexican_less_high_school_model<-lm(NAM ~ estimated_birth_year+log(WEIGHT_FINAL_NORM_OVERALL), data = Mexican_less_high_school)
Mexican_high_school_model<-lm(NAM ~ estimated_birth_year+log(WEIGHT_FINAL_NORM_OVERALL), data = Mexican_high_school)
Mexican_higher_high_school_model<-lm(NAM ~ estimated_birth_year+log(WEIGHT_FINAL_NORM_OVERALL), data = Mexican_higher_high_school)

#Sex
male = Mexican_reclassified[which(Mexican_reclassified$GENDER == 'M'),]
female = Mexican_reclassified[which(Mexican_reclassified$GENDER == 'F'),]

male_model<-lm(NAM ~ estimated_birth_year+log(WEIGHT_FINAL_NORM_OVERALL), data = male)
female_model<-lm(NAM ~ estimated_birth_year+log(WEIGHT_FINAL_NORM_OVERALL), data = female)


###
All<-setNames(data.frame(matrix(ncol = 8, nrow = 0)), c("Category", "N", "Mean","Median","R2","Effect","Std.Err","P"))
 
All[1,1]<-"All"
All[1,2]<-dim(d)[1]
All[1,3]<-mean(d$NAM)
All[1,4]<-median(d$NAM)
All[1,5]<-summary(fit)$r.squared
All[1,6]<-summary(fit)$coeff[2,1]
All[1,7]<-summary(fit)$coeff[2,2]
All[1,8]<-summary(fit)$coeff[2,4]

#chicago
Chicago_df<-setNames(data.frame(matrix(ncol = 8, nrow = 0)), c("Category", "N", "Mean","Median","R2","Effect","Std.Err","P"))

Chicago_df[1,1]<-"Chicago"
Chicago_df[1,2]<-dim(Chicago)[1]
Chicago_df[1,3]<-mean(Chicago$NAM)
Chicago_df[1,4]<-median(Chicago$NAM)
Chicago_df[1,5]<-summary(Chicago_model)$r.squared
Chicago_df[1,6]<-summary(Chicago_model)$coeff[2,1]
Chicago_df[1,7]<-summary(Chicago_model)$coeff[2,2]
Chicago_df[1,8]<-summary(Chicago_model)$coeff[2,4]

#San diego
San_Diego_df<-setNames(data.frame(matrix(ncol = 8, nrow = 0)), c("Category", "N", "Mean","Median","R2","Effect","Std.Err","P"))

San_Diego_df[1,1]<-"San Diego"
San_Diego_df[1,2]<-dim(San_Diego)[1]
San_Diego_df[1,3]<-mean(San_Diego$NAM)
San_Diego_df[1,4]<-median(San_Diego$NAM)
San_Diego_df[1,5]<-summary(San_Diego_model)$r.squared
San_Diego_df[1,6]<-summary(San_Diego_model)$coeff[2,1]
San_Diego_df[1,7]<-summary(San_Diego_model)$coeff[2,2]
San_Diego_df[1,8]<-summary(San_Diego_model)$coeff[2,4]

#US born 
US_born_df<-setNames(data.frame(matrix(ncol = 8, nrow = 0)), c("Category", "N", "Mean","Median","R2","Effect","Std.Err","P"))

US_born_df[1,1]<-"US born"
US_born_df[1,2]<-dim(US_born)[1]
US_born_df[1,3]<-mean(US_born$NAM)
US_born_df[1,4]<-median(US_born$NAM)
US_born_df[1,5]<-summary(US_born_model)$r.squared
US_born_df[1,6]<-summary(US_born_model)$coeff[2,1]
US_born_df[1,7]<-summary(US_born_model)$coeff[2,2]
US_born_df[1,8]<-summary(US_born_model)$coeff[2,4]

#US Migrant
US_migrant_df<-setNames(data.frame(matrix(ncol = 8, nrow = 0)), c("Category", "N", "Mean","Median","R2","Effect","Std.Err","P"))

US_migrant_df[1,1]<-"US migrant"
US_migrant_df[1,2]<-dim(US_migrant)[1]
US_migrant_df[1,3]<-mean(US_migrant$NAM)
US_migrant_df[1,4]<-median(US_migrant$NAM)
US_migrant_df[1,5]<-summary(US_migrant_model)$r.squared
US_migrant_df[1,6]<-summary(US_migrant_model)$coeff[2,1]
US_migrant_df[1,7]<-summary(US_migrant_model)$coeff[2,2]
US_migrant_df[1,8]<-summary(US_migrant_model)$coeff[2,4]

#Male 

male_df<-setNames(data.frame(matrix(ncol = 8, nrow = 0)), c("Category", "N", "Mean","Median","R2","Effect","Std.Err","P"))

male_df[1,1]<-"Male"
male_df[1,2]<-dim(male)[1]
male_df[1,3]<-mean(male$NAM)
male_df[1,4]<-median(male$NAM)
male_df[1,5]<-summary(male_model)$r.squared
male_df[1,6]<-summary(male_model)$coeff[2,1]
male_df[1,7]<-summary(male_model)$coeff[2,2]
male_df[1,8]<-summary(male_model)$coeff[2,4]

#Female
female_df<-setNames(data.frame(matrix(ncol = 8, nrow = 0)), c("Category", "N", "Mean","Median","R2","Effect","Std.Err","P"))

female_df[1,1]<-"Female"
female_df[1,2]<-dim(female)[1]
female_df[1,3]<-mean(female$NAM)
female_df[1,4]<-median(female$NAM)
female_df[1,5]<-summary(female_model)$r.squared
female_df[1,6]<-summary(female_model)$coeff[2,1]
female_df[1,7]<-summary(female_model)$coeff[2,2]
female_df[1,8]<-summary(female_model)$coeff[2,4]

#less than high school
Mexican_less_high_school_df<-setNames(data.frame(matrix(ncol = 8, nrow = 0)), c("Category", "N", "Mean","Median","R2","Effect","Std.Err","P"))

Mexican_less_high_school_df[1,1]<-"<HS"
Mexican_less_high_school_df[1,2]<-dim(Mexican_less_high_school)[1]
Mexican_less_high_school_df[1,3]<-mean(Mexican_less_high_school$NAM)
Mexican_less_high_school_df[1,4]<-median(Mexican_less_high_school$NAM)
Mexican_less_high_school_df[1,5]<-summary(Mexican_less_high_school_model)$r.squared
Mexican_less_high_school_df[1,6]<-summary(Mexican_less_high_school_model)$coeff[2,1]
Mexican_less_high_school_df[1,7]<-summary(Mexican_less_high_school_model)$coeff[2,2]
Mexican_less_high_school_df[1,8]<-summary(Mexican_less_high_school_model)$coeff[2,4]

#high school equiv
Mexican_high_school_df<-setNames(data.frame(matrix(ncol = 8, nrow = 0)), c("Category", "N", "Mean","Median","R2","Effect","Std.Err","P"))

Mexican_high_school_df[1,1]<-"=HS"
Mexican_high_school_df[1,2]<-dim(Mexican_high_school)[1]
Mexican_high_school_df[1,3]<-mean(Mexican_high_school$NAM)
Mexican_high_school_df[1,4]<-median(Mexican_high_school$NAM)
Mexican_high_school_df[1,5]<-summary(Mexican_high_school_model)$r.squared
Mexican_high_school_df[1,6]<-summary(Mexican_high_school_model)$coeff[2,1]
Mexican_high_school_df[1,7]<-summary(Mexican_high_school_model)$coeff[2,2]
Mexican_high_school_df[1,8]<-summary(Mexican_high_school_model)$coeff[2,4]

#Greater than high school 
Mexican_higher_high_school_df<-setNames(data.frame(matrix(ncol = 8, nrow = 0)), c("Category", "N", "Mean","Median","R2","Effect","Std.Err","P"))

Mexican_higher_high_school_df[1,1]<-">HS"
Mexican_higher_high_school_df[1,2]<-dim(Mexican_higher_high_school)[1]
Mexican_higher_high_school_df[1,3]<-mean(Mexican_higher_high_school$NAM)
Mexican_higher_high_school_df[1,4]<-median(Mexican_higher_high_school$NAM)
Mexican_higher_high_school_df[1,5]<-summary(Mexican_higher_high_school_model)$r.squared
Mexican_higher_high_school_df[1,6]<-summary(Mexican_higher_high_school_model)$coeff[2,1]
Mexican_higher_high_school_df[1,7]<-summary(Mexican_higher_high_school_model)$coeff[2,2]
Mexican_higher_high_school_df[1,8]<-summary(Mexican_higher_high_school_model)$coeff[2,4]


###Merging all models 
all_models<-rbind(All,Chicago_df,San_Diego_df,US_born_df,US_migrant_df,male_df,female_df,Mexican_less_high_school_df,Mexican_high_school_df,Mexican_higher_high_school_df)

```

The following section is for Supplementary Figure 1 of the paper 

```{r}
NAM_phenotypes<-read.table("/Users/melissaspear/Dropbox/HCHS_SOL/ref_panel_related/Reich2012_NAM_refs_only_tribe_country.txt",header=T,sep=" ")

############################################################################
####Plotting the UMAP plot, cleared history and copied/pasted 
fam_filename<-"/Users/melissaspear/Dropbox/HCHS_SOL/smartPCA/data/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED.fam"
fam_file<-read.table(fam_filename,header=F,sep=" ")
names(fam_file)<-c("FID","IID","PID","MID","Sex","Pheno")


#Reading in the phenotype 
all_samples_pheno<-read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_allphenotypes_ALL_samples_new_birthyear.txt", header=T, sep ='\t')
pheno_shortened<-subset(all_samples_pheno, select = c("SUBJECT_ID", "estimated_birth_year", "BKGRD1_C7"))
combined_pheno_fam<-merge(pheno_shortened, fam_file, by.x=c("SUBJECT_ID"), by.y =c("FID"))

#merging the umap results with the HCHS/SOL phenotypes 

latinx_color_palette<-(brewer.pal(7,"Set2"))
latinx_color_palette2<-(brewer.pal(11,"BrBG"))

umap_results_filename<-"/Users/melissaspear/Dropbox/HCHS_SOL/UMAP/overlap_with_ref/projections/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED_UMAP_PC3_NC2_NN15_MD0.5_201944194827.txt"
umap_results  <- read.table(umap_results_filename,header=F)
final_umap_file<-cbind(fam_file,umap_results)

CEU<-final_umap_file[1:104,]
CEU$Population = "CEU" 

YRI<-final_umap_file[105:211,]
YRI$Population = "YRI"

NAM<-final_umap_file[212:323,]
NAM$Population = "NAM"
NAM_umap_with_pheno<-merge(NAM_phenotypes,NAM,by.x=c("IID"),by.y=c("IID"))
Final_NAM_pops<-subset(NAM_umap_with_pheno,select=c("IID","Country","V1","V2")) #Grouping the Populations by Country

CEU_pop = subset(CEU,select=c("IID","Population","V1","V2"))
YRI_pop = subset(YRI,select=c("IID","Population","V1","V2"))

names(Final_NAM_pops)<-c("IID","Population","V1","V2")
umap_pheno<-merge(combined_pheno_fam, final_umap_file, by.x=c("SUBJECT_ID"), by.y =c("FID"))
umap_pheno_subset<-subset(umap_pheno, select=c("IID.x","estimated_birth_year","BKGRD1_C7","V1","V2"))
  
#subset the latinx groups 
Dominican_reclassified<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "0"),]
Central_American_reclassified<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "1"),]
Cuban_reclassified<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "2"),]
Mexican_reclassified<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "3"),]
Puerto_Rican_reclassified<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "4"),]
South_American_reclassified<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "5"),]
Mixed_Other<-umap_pheno_subset[which(umap_pheno_subset$BKGRD1_C7 == "6"),]
  
Cuban_reclassified$Population = "HCHS/SOL-Cuban"
Dominican_reclassified$Population = "HCHS/SOL-Dominican"
Puerto_Rican_reclassified$Population = "HCHS/SOL-Puerto Rican"
Mexican_reclassified$Population = "HCHS/SOL-Mexican"
Central_American_reclassified$Population = "HCHS/SOL-Central American"
South_American_reclassified$Population = "HCHS/SOL-South American"
Mixed_Other$Population = "HCHS/SOL-Mixed/Other"
  
all_Latinx_pops<-rbind(Mexican_reclassified,Puerto_Rican_reclassified,Cuban_reclassified,Dominican_reclassified,Central_American_reclassified,South_American_reclassified,Mixed_Other)
Final_Latinx_pops<-subset(all_Latinx_pops,select=c("IID.x","Population","V1","V2"))
names(Final_Latinx_pops)<-c("IID","Population","V1","V2")
  
all_pops<-rbind(Final_Latinx_pops,Final_NAM_pops,CEU_pop,YRI_pop)

####separating out teh nam pops 

Mexico = Final_NAM_pops[which(Final_NAM_pops$Population=="Mexico"),]
Guatemala = Final_NAM_pops[which(Final_NAM_pops$Population=="Guatemala"),]
Costa_Rica = Final_NAM_pops[which(Final_NAM_pops$Population=="Costa_Rica"),]
Colombia = Final_NAM_pops[which(Final_NAM_pops$Population=="Colombia"),]
Guiana = Final_NAM_pops[which(Final_NAM_pops$Population=="Guiana"),]
Brazil = Final_NAM_pops[which(Final_NAM_pops$Population=="Brazil"),]
Bolivia_Peru = Final_NAM_pops[which(Final_NAM_pops$Population=="Bolivia_Peru"),]
Bolivia_Chile = Final_NAM_pops[which(Final_NAM_pops$Population=="Bolivia_Chile"),]
Paraguay_Argentina = Final_NAM_pops[which(Final_NAM_pops$Population=="Paraguay_Argentina"),]
Argentina = Final_NAM_pops[which(Final_NAM_pops$Population=="Argentina"),]
Chile = Final_NAM_pops[which(Final_NAM_pops$Population=="Chile"),]

### Colors by Country 
require(RColorBrewer)
mypalette<-(brewer.pal(11,"RdYlBu"))

#grey scale- supplementary figure 1C  
paired<-(brewer.pal(12,"Paired"))
set3<-(brewer.pal(9,"Set3"))


#pdf('/Users/melissaspear/Dropbox/HCHS_SOL/UMAP/overlap_with_ref/plots/HCHS_SOL_with_ref_mixed_other_101619_3PCs_greycolors_NAMhighlighted_topleft_legend.pdf',height=2.375,width=2.375,pointsize=5)
par(mar=c(2.1,2.1,0.1,0.1))  
#par(mar=c(3,3,1,1))
#legend("bottomright",legend=c("HCHS/SOL-Cuban","HCHS/SOL-Dominican","HCHS/SOL-Puerto Rican","HCHS/SOL-Mexican","HCHS/SOL-Central American","HCHS/SOL-South American","HCHS/SOL-Mixed/Other"),col=c("#543005","#DFC27D","#8C510A","#003C30", "#01665E","#80CDC1","#F5F5F5"),pch=5,cex=0.6,bg='white')
plot(all_pops$V1,all_pops$V2,pch=0,type='n',xlab="",ylab="",xaxt='n',yaxt='n',bty='n')
legend("topleft",legend=c("Mexico","Guatemala","Costa_Rica","Colombia","Guiana","Brazil","Bolivia/Peru","Bolivia/Chile","Paraguay/Argentina","Argentina","Chile","CEU","YRI"),col=c(paired[2],paired[5],paired[1],paired[4],paired[3],paired[6],paired[7],paired[8],paired[9],paired[10],paired[11],"black","darkgrey"),pch=18,cex=0.65,bg='white',bty = "n")

points(Mexican_reclassified$V1,Mexican_reclassified$V2,col=set3[9],pch=5,cex=0.1)
points(Central_American_reclassified$V1,Central_American_reclassified$V2,col=set3[9],pch=5,cex=0.1)
points(South_American_reclassified$V1,South_American_reclassified$V2,col=set3[9],pch=5,cex=0.1)
points(Dominican_reclassified$V1,Dominican_reclassified$V2,col=set3[9],pch=5,cex=0.1)
points(Cuban_reclassified$V1,Cuban_reclassified$V2,col=set3[9],pch=5,cex=0.1)
points(Puerto_Rican_reclassified$V1,Puerto_Rican_reclassified$V2,col=set3[9],pch=5,cex=0.1)
points(Mixed_Other$V1,Mixed_Other$V2,col=set3[9],pch=5,cex=0.1)
points(CEU$V1,CEU$V2,col="black",pch=18,cex=0.6)
points(YRI$V1,YRI$V2,col="darkgrey",pch=18,cex=0.6)
#points(NAM$V1,NAM$V2,col=pcol2[1],pch=5,cex=0.1)
points(Mexico$V1,Mexico$V2,col=paired[2],pch=18,cex=0.6)
points(Guatemala$V1,Guatemala$V2,col=paired[5],pch=18,cex=0.6)
points(Costa_Rica$V1,Costa_Rica$V2,col=paired[1],pch=18,cex=0.6)
points(Colombia$V1,Colombia$V2,col=paired[4],pch=18,cex=0.6)
points(Guiana$V1,Guiana$V2,col=paired[3],pch=18,cex=0.6)
points(Brazil$V1,Brazil$V2,col=paired[6],pch=18,cex=0.6)
points(Bolivia_Peru$V1,Bolivia_Peru$V2,col=paired[7],pch=18,cex=0.6)
points(Bolivia_Chile$V1,Bolivia_Chile$V2,col=paired[8],pch=18,cex=0.6)
points(Paraguay_Argentina$V1,Paraguay_Argentina$V2,col=paired[9],pch=18,cex=0.6)
points(Argentina$V1,Argentina$V2,col=paired[10],pch=18,cex=0.6)
points(Chile$V1,Chile$V2,col=paired[11],pch=18,cex=0.6)

#dev.off()

```


The following section is for Supplementary Figure 2 of the paper 

The following section is for Supplementary Figure 3 of the paper.

The following section is for Supplementary Figure 4 of the paper 

The following section is for Supplementary Figure 5 of the paper.

The following section is for Supplementary Table 1 of the paper.


This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
