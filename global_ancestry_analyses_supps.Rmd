---
title: "global_ancestry_analyses_supps"
author: "Melissa Spear"
date: "07/05/2020"
output: html_document
---
The following describes the analyses discussed within the global ancestry analyses of the paper. This includes Supplementary Figures 1-6 and Supplementay Table 1.

```{r}
#Supplementary Figure 2
allchr = read.table("/Volumes/LaCie/Downloads/HCHS_SOL_only_ALLChr_RFMix_global_ancestry_estimates_050819.txt", header=T, stringsAsFactor = F)

# Reading in the ADMIXTURE estimates
HCHS_SOL_admixture_file<-read.table("/Volumes/LaCie/Downloads/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED.3.Q",header=F,sep=' ')
names(HCHS_SOL_admixture_file)<-c("YRI","CEU","NAM")

#reading in the fam file accompaniment of the .bed file i used for the admixture run 
fam_file = read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED.fam", header=F, sep = ' ')
fam_file_with_IDs <- cbind(fam_file, HCHS_SOL_admixture_file)

#Merge admixture estiamtes with RFMix estimates
admixture_with_RFMIX_global <- merge(fam_file_with_IDs, allchr, by.x =c("V2"), by.y=c("SAMPLE_ID"))

```

Supplementary Figure 2
```{r}
#####Plotting the plot for the paper. 
require(RColorBrewer)
pcol=brewer.pal(9, "Set1")

#Euro = Red, Native=Blue,African =Green
#pdf("/Users/melissaspear/Dropbox/HCHS_SOL/paper/figures/HCHS_SOL_RFMix_ADMIXTURE_ancestry_concordance_050819.pdf",height=2.25,width=7.25,pointsize=10)
par(mfrow=c(1,3))
par(mar=c(2.1,2.1,0.1,0.1))
plot(1,1,type='n',xlim=c(0,1),ylim=c(0,1),xlab="",ylab="",xaxt='n',yaxt='n')
abline(h=seq(0,1,by=0.1),col=rgb(0,0,0,0.1))
abline(v=seq(0,1,by=0.1),col=rgb(0,0,0,0.1))
abline(0,1,col="black")
axis(side=1,padj=-2,cex.axis=0.7)
axis(side=2,padj=1.5,cex.axis=0.7)
mtext(side=1,"ADMIXTURE (%)",line=1.1,cex=0.75)
mtext(side=2,"RFMix (%)",line=1.1,cex=0.75)
points(admixture_with_RFMIX_global$NAM.x, admixture_with_RFMIX_global$NAM_global_mean,col=pcol[2],pch=16,cex=.5)
plot(1,1,type='n',xlim=c(0,1),ylim=c(0,1),xlab="",ylab="",xaxt='n',yaxt='n')
abline(h=seq(0,1,by=0.1),col=rgb(0,0,0,0.1))
abline(v=seq(0,1,by=0.1),col=rgb(0,0,0,0.1))
abline(0,1,col="black")
axis(side=1,padj=-2,cex.axis=0.7)
axis(side=2,padj=1.5,cex.axis=0.7)
mtext(side=1,"ADMIXTURE (%)",line=1.1,cex=0.75)
mtext(side=2,"RFMix (%)",line=1.1,cex=0.75)
points(admixture_with_RFMIX_global$YRI, admixture_with_RFMIX_global$AFR_global_mean,col=pcol[1],pch=16,cex=.5)
plot(1,1,type='n',xlim=c(0,1),ylim=c(0,1),xlab="",ylab="",xaxt='n',yaxt='n')
abline(h=seq(0,1,by=0.1),col=rgb(0,0,0,0.1))
abline(v=seq(0,1,by=0.1),col=rgb(0,0,0,0.1))
abline(0,1,col="black")
axis(side=1,padj=-2,cex.axis=0.7)
axis(side=2,padj=1.5,cex.axis=0.7)
mtext(side=1,"ADMIXTURE (%)",line=1.1,cex=0.75)
mtext(side=2,"RFMix (%)",line=1.1,cex=0.75)
points(admixture_with_RFMIX_global$CEU, admixture_with_RFMIX_global$EUR_global_mean,col=pcol[3],pch=16,cex=.5)
#dev.off()

```

Supplementary Figure 3
```{r}
allchr = read.table("/Volumes/LaCie/Downloads/HCHS_SOL_only_ALLChr_RFMix_global_ancestry_estimates_050819.txt", header=T, stringsAsFactor = F)

# Reading in the ADMIXTURE estimates
HCHS_SOL_admixture_file<-read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED.3.Q",header=F,sep=' ')
names(HCHS_SOL_admixture_file)<-c("YRI","CEU","NAM")

#reading in the fam file accompaniment of the .bed file i used for the admixture run 
fam_file = read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_clean_set_with_Reich_NAM_CEU_YRI_hg19_FINAL_030718_forwardstrand_PRUNED.fam", header=F, sep = ' ')
fam_file_with_IDs <- cbind(fam_file, HCHS_SOL_admixture_file)

#Merge admixture estiamtes with RFMix estimates
d = read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_Mexicans_admixed_95_full_pheno_010919.txt",header=T,sep='\t')

admixture_with_RFMIX_global <- merge(fam_file_with_IDs, allchr, by.x =c("V2"), by.y=c("SAMPLE_ID"))

pheno_new_global_ancestry_estiamtes<-merge(d,admixture_with_RFMIX_global,by.x=c("V2"),by.y=c("V2"))

fit = lm(pheno_new_global_ancestry_estiamtes[,301] ~ pheno_new_global_ancestry_estiamtes[,284]+log(pheno_new_global_ancestry_estiamtes[,179])) #linear model: Native ancestry vs birth year

fit = lm(pheno_new_global_ancestry_estiamtes[,301] ~ pheno_new_global_ancestry_estiamtes[,284]+log(pheno_new_global_ancestry_estiamtes[,179])) #linear model: Native ancestry vs birth year


#plot code it self 
#pdf("/Users/melissaspear/Dropbox/HCHS_SOL/paper/figures/HCHS_SOL_RFMix_NativeAmerican_ancestry_points+wiskers_dbins_071519_supplementary_figure3.pdf",height=2.25,width=2.375,pointsize=10)
par(mar=c(2.1,2.1,0.1,0.1))
plot(1,1,type='n',xlim=range(pheno_new_global_ancestry_estiamtes[,284]),ylim=c(0,1),xlab="",ylab="",xaxt='n',yaxt='n')
abline(h=seq(0,1,by=0.1),col=rgb(0,0,0,0.1))
abline(v=seq(1930,2000,by=5),col=rgb(0,0,0,0.1))
axis(side=1,padj=-2,cex.axis=0.7)
axis(side=2,padj=1.5,cex.axis=0.7)
mtext(side=1,"Birth year",line=1.1)
mtext(side=2,"Amerindigenous ancestry (%)",line=1.1)
c=col2rgb(pcol[2])/255;
I1 = which.min(pheno_new_global_ancestry_estiamtes[,284])
I2 = which.max(pheno_new_global_ancestry_estiamtes[,284])
points(pheno_new_global_ancestry_estiamtes[,284],pheno_new_global_ancestry_estiamtes[,301],col=rgb(c[1],c[2],c[3],0.2),pch=16,cex=0.5)
segments(x0=pheno_new_global_ancestry_estiamtes[I1,284], x1=pheno_new_global_ancestry_estiamtes[I2,284],y0=fit$fitted.values[I1],y1=fit$fitted.values[I2],col="white",lwd=3)
segments(x0=pheno_new_global_ancestry_estiamtes[I1,284], x1=pheno_new_global_ancestry_estiamtes[I2,284],y0=fit$fitted.values[I1],y1=fit$fitted.values[I2],col=pcol[2],lwd=2)

pw = 10 #partition width, in years
part=seq(min(floor(pheno_new_global_ancestry_estiamtes[,301]/10)*10),max(ceiling(pheno_new_global_ancestry_estiamtes[,284]/10)*10),by=pw)
for(i in 1:(length(part)-1)){
  q1 = max(part[i],min(pheno_new_global_ancestry_estiamtes[,284]));
  q2 = min(part[i+1],max(pheno_new_global_ancestry_estiamtes[,284]));
  dbin = pheno_new_global_ancestry_estiamtes[which(pheno_new_global_ancestry_estiamtes[,284]>q1 & pheno_new_global_ancestry_estiamtes[,284]<=q2),]
  m = mean(dbin[,301],na.rm=T)
  se = 2*sd(dbin[,301],na.rm=T)/sqrt(nrow(dbin))
  segments(x0=q1,x1=q2,y0=m)
  segments(x0=(q1+q2)/2,y0=m-se,y1=m+se)
  cat(i,q1,q2,m,se,"\n",sep="\t")
}
#dev.off()

```

Supplementary Figure 4 
```{r}
setwd("/Users/melissaspear/Dropbox/HCHS_SOL/paper_figures")
MX_pheno<-read.table("/Users/melissaspear/Dropbox/HCHS_SOL/HCHS_SOL_Mexicans_admixed_95_full_pheno_010919.txt",header=T,sep='\t')

no_na=MX_pheno[which(!is.na(MX_pheno$CLINDATE_YR)),]
with_na = MX_pheno[which(is.na(MX_pheno$CLINDATE_YR)),]
fit = lm(NAM ~ estimated_birth_year+WEIGHT_FINAL_NORM_OVERALL,data=no_na)

library(boot)

MX_1930s<-MX_pheno[which(MX_pheno$estimated_birth_year>='1930'&MX_pheno$estimated_birth_year<'1940'),]
MX_1930s$Decade<-"1930s"

MX_1940s<-MX_pheno[which(MX_pheno$estimated_birth_year>='1940'&MX_pheno$estimated_birth_year<'1950'),]
MX_1940s$Decade<-"1940s"

MX_1950s<-MX_pheno[which(MX_pheno$estimated_birth_year>='1950'&MX_pheno$estimated_birth_year<'1960'),]
MX_1950s$Decade<-"1950s"

MX_1960s<-MX_pheno[which(MX_pheno$estimated_birth_year>='1960'&MX_pheno$estimated_birth_year<'1970'),]
MX_1960s$Decade<-"1960s"

MX_1970s<-MX_pheno[which(MX_pheno$estimated_birth_year>='1970'&MX_pheno$estimated_birth_year<'1980'),]
MX_1970s$Decade<-"1970s"

MX_1980s<-MX_pheno[which(MX_pheno$estimated_birth_year>='1980'&MX_pheno$estimated_birth_year<'1990'),]
MX_1980s$Decade<-"1980s"

MX_1990s<-MX_pheno[which(MX_pheno$estimated_birth_year>='1990'),]
MX_1990s$Decade<-"1990s"


#9 is the 9th column which is the NAM column 
sapply(9, function(x) mean(MX_1930s[,x]))
sapply(9, function(x) mean(MX_1940s[,x]))
sapply(9, function(x) mean(MX_1950s[,x]))
sapply(9, function(x) mean(MX_1960s[,x]))
sapply(9, function(x) mean(MX_1970s[,x]))
sapply(9, function(x) mean(MX_1980s[,x]))
sapply(9, function(x) mean(MX_1990s[,x]))


#Bootstrap resampling

#1930s
set.seed(1234)
resamples_1930s<-lapply(1:1000,function(i) sample(MX_1930s$NAM,replace=T))
resamples_means_1930s<-sapply(resamples_1930s,mean)
#sqrt(var(resamples_means_1930s))


#1940s
set.seed(1234)
resamples_1940s<-lapply(1:1000,function(i) sample(MX_1940s$NAM,replace=T))
resamples_means_1940s<-sapply(resamples_1940s,mean)
#sqrt(var(resamples_means_1940s))

#1950s
set.seed(1234)
resamples_1950s<-lapply(1:1000,function(i) sample(MX_1950s$NAM,replace=T))
resamples_means_1950s<-sapply(resamples_1950s,mean)
#sqrt(var(resamples_means_1950s))

#1960s
set.seed(1234)
resamples_1960s<-lapply(1:1000,function(i) sample(MX_1960s$NAM,replace=T))
resamples_means_1960s<-sapply(resamples_1960s,mean)
#sqrt(var(resamples_means_1960s))

#1970s
set.seed(1234)
resamples_1970s<-lapply(1:1000,function(i) sample(MX_1970s$NAM,replace=T))
resamples_means_1970s<-sapply(resamples_1970s,mean)
#sqrt(var(resamples_means_1970s))

#1980s
set.seed(1234)
resamples_1980s<-lapply(1:1000,function(i) sample(MX_1980s$NAM,replace=T))
resamples_means_1980s<-sapply(resamples_1980s,mean)
#sqrt(var(resamples_means_1980s))

#1990s
set.seed(1234)
resamples_1990s<-lapply(1:1000,function(i) sample(MX_1990s$NAM,replace=T))
resamples_means_1990s<-sapply(resamples_1990s,mean)
#sqrt(var(resamples_means_1990s))

########################
#
# Plotting the ridgeline plot of the bootstrap resampling 
#
########################
library(ggplot2)
library(ggridges)
#need to reshape the data

#reshaping the data in order to work with ggridges
#1930s
df.means.1930s=data.frame(resamples_means_1930s)
names(df.means.1930s)=c("NAM_means")
df.means.1930s$Decade<-"1930s"
df.means.1930s$ascending_decade<-"1"
df.means.1930s$descending_decade<-"7"

#1940s
df.means.1940s=data.frame(resamples_means_1940s)
names(df.means.1940s)=c("NAM_means")
df.means.1940s$Decade<-"1940s"
df.means.1940s$ascending_decade<-"2"
df.means.1940s$descending_decade<-"6"

#1950s
df.means.1950s=data.frame(resamples_means_1950s)
names(df.means.1950s)=c("NAM_means")
df.means.1950s$Decade<-"1950s"
df.means.1950s$ascending_decade<-"3"
df.means.1950s$descending_decade<-"5"

#1960s
df.means.1960s=data.frame(resamples_means_1960s)
names(df.means.1960s)=c("NAM_means")
df.means.1960s$Decade<-"1960s"
df.means.1960s$ascending_decade<-"4"
df.means.1960s$descending_decade<-"4"

#1970s
df.means.1970s=data.frame(resamples_means_1970s)
names(df.means.1970s)=c("NAM_means")
df.means.1970s$Decade<-"1970s"
df.means.1970s$ascending_decade<-"5"
df.means.1970s$descending_decade<-"3"

#1980s
df.means.1980s=data.frame(resamples_means_1980s)
names(df.means.1980s)=c("NAM_means")
df.means.1980s$Decade<-"1980s"
df.means.1980s$ascending_decade<-"6"
df.means.1980s$descending_decade<-"2"

#1990s
df.means.1990s=data.frame(resamples_means_1990s)
names(df.means.1990s)=c("NAM_means")
df.means.1990s$Decade<-"1990s"
df.means.1990s$ascending_decade<-"7"
df.means.1990s$descending_decade<-"1"


all_decades<-rbind(df.means.1930s,df.means.1940s,df.means.1950s,df.means.1960s,df.means.1970s,df.means.1980s,df.means.1990s)

require(RColorBrewer)
myColors=brewer.pal(7, "Set1")

#Plotting ridgeline plot
pdf("MX_NAM_ancestry_ridgeline_plot_bootstrap_resampling_072319_supplementary_figure4.pdf",height=2.375,width=2.375,pointsize=10)
par(mar=c(2.1,2.1,0.1,0.2))
ggplot(all_decades,aes(x=NAM_means,y=Decade,fill=factor(Decade))) +
  geom_density_ridges(scale=1)+ theme_bw() + theme(axis.text.x=element_text(size=rel(0.8)),axis.text.y=element_text(size=rel(0.8))) + theme(axis.title.x = element_text(size=10),axis.title.y = element_text(size=10))+
  scale_y_discrete(expand=c(0.1,0)) + scale_fill_manual(values=c("#E41A1C","#FF7F00","#FFFF33","#4DAF4A","#377EB8","#984EA3","#A65628")) + theme(legend.position = "none") + labs(x="Amerindigenous ancestry (%)", y="Decades")
dev.off()

```

